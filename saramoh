import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import uuid

st.set_page_config(page_title='Ù„ÙˆØ­Ø© Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØµØ­Ø© â€” Ø³ÙˆØ±ÙŠØ©', layout='wide')

if 'auth_ok' not in st.session_state: st.session_state.auth_ok=False
def do_login(user,pw): return user=='minister' and pw=='moh2025'
if not st.session_state.auth_ok:
    st.markdown('<h2 style="text-align:center">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>', unsafe_allow_html=True)
    with st.form('login_form'):
        username=st.text_input('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', value='')
        password=st.text_input('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', value='', type='password')
        submit=st.form_submit_button('Ø¯Ø®ÙˆÙ„')
        if submit:
            if do_login(username,password):
                st.session_state.auth_ok=True
                if 'session_id' not in st.session_state: st.session_state.session_id=str(uuid.uuid4())
                st.rerun()
            else:
                st.error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©')
    st.stop()

PRIMARY='#0f3d33'; GOLD='#c6ab6e'; ACCENT1='#8bb69b'; WARN='#ef6c00'; DANGER='#c62828'; MUTED='#9e9e9e'
SEQ=[PRIMARY,GOLD,ACCENT1,WARN,DANGER,MUTED]
st.markdown('''<style>html, body, [class*="css"]{direction:rtl;font-family:"Noto Naskh Arabic","Tahoma","Segoe UI",sans-serif;}h1,h2,h3,h4{font-weight:700}.sidebar .sidebar-content{direction:rtl;text-align:right}.stMetric{font-size:1.1rem}</style>''', unsafe_allow_html=True)

@st.cache_data(show_spinner=False)
def load_csv(path_or_buffer):
    return pd.read_csv(path_or_buffer, encoding='utf-8')

st.sidebar.header('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª')
uploaded=st.sidebar.file_uploader('Ø§Ø±ÙØ¹ CSV Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ', type=['csv'])
try:
    df=load_csv(uploaded) if uploaded else load_csv('seed_moh_dataset.csv')
except FileNotFoundError:
    st.error('Ù…Ù„Ù seed_moh_dataset.csv ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. Ø´ØºÙ‘Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ù„Ù.')
    st.stop()
except UnicodeDecodeError:
    st.error('Ø®Ø·Ø£ ØªØ±Ù…ÙŠØ² Ø§Ù„Ù…Ù„Ù. Ø§Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø¨ØªØ±Ù…ÙŠØ² UTF-8.')
    st.stop()
except Exception as e:
    st.error(f'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: {e}')
    st.stop()

def to_datetime_naive(series):
    try:
        s=pd.to_datetime(series, errors='coerce')
        if s.dt.tz is not None: s=s.dt.tz_convert(None)
        return s
    except Exception:
        return pd.to_datetime(series, errors='coerce', utc=True).dt.tz_convert(None)

if 'DateOfVisit' in df.columns: df['DateOfVisit']=to_datetime_naive(df['DateOfVisit'])
for c in ['q1.9.6','q1.9.7','q3.1','q3.1_active','q3.1_not_active','q3.1_admission_avg','q3.3.1_active','q3.3.1_inactive','q3.3.2_active','q3.3.2_inactive','q3.3.3_active','q3.3.3_inactive']:
    if c in df.columns: df[c]=pd.to_numeric(df[c], errors='coerce')

st.sidebar.header('Ø§Ù„ÙÙ„Ø§ØªØ±')
fid=st.sidebar.text_input('Ø§Ù„Ø±Ù…Ø² Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ Ù„Ù„Ù…Ù†Ø´Ø£Ø©').strip() if 'facility_id' in df.columns else ''
if fid: df=df[df['facility_id'].astype(str).str.contains(fid, case=False, na=False)]
fname=st.sidebar.text_input('Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©').strip() if 'facility_name' in df.columns else ''
if fname: df=df[df['facility_name'].astype(str).str.contains(fname, case=False, na=False)]
if 'governorate_entry' in df.columns:
    govs=sorted(df['governorate_entry'].dropna().unique())
    sel_govs=st.sidebar.multiselect('Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©', options=govs, default=govs)
    if sel_govs: df=df[df['governorate_entry'].isin(sel_govs)]
if 'area_entry' in df.columns:
    areas=sorted(df['area_entry'].dropna().unique())
    sel_areas=st.sidebar.multiselect('Ø§Ù„Ù…Ù†Ø·Ù‚Ø©/Ø§Ù„Ù„ÙˆØ§Ø¡', options=areas, default=[])
    if sel_areas: df=df[df['area_entry'].isin(sel_areas)]
if 'DateOfVisit' in df.columns and df['DateOfVisit'].notna().any():
    min_d=df['DateOfVisit'].min().date(); max_d=df['DateOfVisit'].max().date()
    dr=st.sidebar.date_input('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©', value=(min_d,max_d))
    if isinstance(dr,tuple) and len(dr)==2:
        start=pd.to_datetime(dr[0]); end=pd.to_datetime(dr[1])+pd.Timedelta(days=1)-pd.Timedelta(seconds=1)
        df=df[(df['DateOfVisit']>=start) & (df['DateOfVisit']<=end)]
if 'facility_state' in df.columns:
    states=sorted(df['facility_state'].dropna().unique())
    sel_states=st.sidebar.multiselect('Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø´Ø£Ø©', options=states, default=[])
    if sel_states: df=df[df['facility_state'].isin(sel_states)]
if 'q1.7' in df.columns:
    cats=sorted(df['q1.7'].dropna().unique())
    sel_cats=st.sidebar.multiselect('ÙØ¦Ø© Ø§Ù„Ù…Ù†Ø´Ø£Ø©', options=cats, default=[])
    if sel_cats: df=df[df['q1.7'].isin(sel_cats)]
if 'q1.8' in df.columns:
    deps=sorted(df['q1.8'].dropna().unique())
    sel_deps=st.sidebar.multiselect('ØªØ¨Ø¹ÙŠØ© Ø§Ù„Ù…Ù†Ø´Ø£Ø©', options=deps, default=[])
    if sel_deps: df=df[df['q1.8'].isin(sel_deps)]

def is_yes(x): return str(x).strip() in ['1','True','true','Ù†Ø¹Ù…','yes','Yes']
def percent(n,d): return (n/d*100) if d else 0

def kpis(df):
    c1,c2,c3,c4,c5=st.columns(5)
    total=len(df)
    working=df['facility_state'].eq('ØªØ¹Ù…Ù„').sum() if 'facility_state' in df.columns else 0
    partial=df['facility_state'].eq('ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø¬Ø²Ø¦ÙŠ').sum() if 'facility_state' in df.columns else 0
    not_work=df['facility_state'].eq('Ù„Ø§ ØªØ¹Ù…Ù„').sum() if 'facility_state' in df.columns else 0
    licensed=df['q1.10'].apply(is_yes).sum() if 'q1.10' in df.columns else 0
    avgv=df['q1.9.6'].mean() if 'q1.9.6' in df.columns else 0
    c1.metric('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†Ø´Ø¢Øª ðŸ¥', f'{total:,}')
    c2.metric('Ø§Ù„Ø¹Ø§Ù…Ù„Ø© âœ…', f'{working:,}', f'{percent(working,total):.1f}%')
    c3.metric('Ø¬Ø²Ø¦ÙŠ/Ù…ØªÙˆÙ‚Ù âš ï¸', f'{partial+not_work:,}', f'{percent(partial+not_work,total):.1f}%')
    c4.metric('Ù…Ø±Ø®ØµØ© ðŸ›¡ï¸', f'{licensed:,}', f'{percent(licensed,total):.1f}%')
    c5.metric('Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ÙŠÙ†/Ø´Ù‡Ø± ðŸ‘¥', f'{avgv:,.0f}')
    st.markdown('---')

st.markdown(f"<h2 style='color:{PRIMARY}'>Ù„ÙˆØ­Ø© Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„ØµØ­ÙŠ - ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø© Ø§Ù„Ø³ÙˆØ±ÙŠØ©</h2>", unsafe_allow_html=True)
tabs=st.tabs(['Ø§Ù„Ù†Ø¸Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©','Ø§Ù„Ø®Ø¯Ù…Ø§Øª','Ø§Ù„ÙƒØ§Ø¯Ø±','Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª','Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ©','Ø§Ù„Ø³Ø¬Ù„'])

with tabs[0]:
    kpis(df)
    col1,col2=st.columns(2)
    if 'governorate_entry' in df.columns and 'facility_state' in df.columns and len(df):
        grouped=df.groupby(['governorate_entry','facility_state']).size().reset_index(name='Ø¹Ø¯Ø¯')
        fig=px.bar(grouped, x='governorate_entry', y='Ø¹Ø¯Ø¯', color='facility_state', barmode='stack', title='Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø´Ø¢Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©', color_discrete_sequence=SEQ, labels={'governorate_entry':'Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©'})
        fig.update_layout(xaxis_tickangle=-20, margin=dict(t=60,b=100), legend_title_text='Ø§Ù„Ø­Ø§Ù„Ø©')
        col1.plotly_chart(fig, use_container_width=True)
    if 'q1.7' in df.columns and len(df):
        cat=df['q1.7'].value_counts().reset_index(); cat.columns=['ÙØ¦Ø© Ø§Ù„Ù…Ù†Ø´Ø£Ø©','Ø¹Ø¯Ø¯']
        fig2=px.pie(cat, names='ÙØ¦Ø© Ø§Ù„Ù…Ù†Ø´Ø£Ø©', values='Ø¹Ø¯Ø¯', hole=0.45, title='ØªÙˆØ²ÙŠØ¹ ÙØ¦Ø§Øª Ø§Ù„Ù…Ù†Ø´Ø¢Øª', color_discrete_sequence=SEQ)
        col2.plotly_chart(fig2, use_container_width=True)
    st.markdown('---')
    col3,col4=st.columns(2)
    if 'q1.8' in df.columns:
        dep=df['q1.8'].value_counts().reset_index(); dep.columns=['ØªØ¨Ø¹ÙŠØ© Ø§Ù„Ù…Ù†Ø´Ø£Ø©','Ø¹Ø¯Ø¯']
        fig3=px.bar(dep, x='ØªØ¨Ø¹ÙŠØ© Ø§Ù„Ù…Ù†Ø´Ø£Ø©', y='Ø¹Ø¯Ø¯', title='ØªØ¨Ø¹ÙŠØ© Ø§Ù„Ù…Ù†Ø´Ø¢Øª', color_discrete_sequence=[PRIMARY])
        fig3.update_layout(xaxis_tickangle=-20, margin=dict(t=60,b=100))
        col3.plotly_chart(fig3, use_container_width=True)
    if 'lat' in df.columns and 'lon' in df.columns and df[['lat','lon']].notna().any().any():
        mdf=df.dropna(subset=['lat','lon'])
        mapfig=px.scatter_mapbox(mdf, lat='lat', lon='lon', hover_name='facility_name', color='facility_state', color_discrete_sequence=SEQ, zoom=5, height=450)
        mapfig.update_layout(mapbox_style='open-street-map', margin=dict(t=0,b=0,l=0,r=0))
        col4.plotly_chart(mapfig, use_container_width=True)
    else:
        col4.info('Ù„Ø§ ØªØªÙˆÙØ± Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (lat/lon) Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø©. Ø£Ø¶Ù Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© lat, lon ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø®Ø±ÙŠØ·Ø©.')

with tabs[1]:
    kpis(df)
    service_map={'q1.20_1':'ØªÙ†Ø¸ÙŠÙ… Ø£Ø³Ø±Ø©','q1.20_2':'Ø±Ø¹Ø§ÙŠØ© Ø­Ø§Ù…Ù„','q1.20_3':'Ø±Ø¹Ø§ÙŠØ© Ø§Ù„Ø£Ù…','q1.20_4':'Ø®Ø¯Ù…Ø§Øª Ù†Ø³Ø§Ø¦ÙŠØ© Ø£Ø®Ø±Ù‰','q1.20_5':'Ø±Ø¹Ø§ÙŠØ© ÙˆÙ„ÙŠØ¯','q1.20_6':'ØªÙˆÙ„ÙŠØ¯ Ø·Ø¨ÙŠØ¹ÙŠ','q1.20_7':'ÙˆÙ„Ø§Ø¯Ø© Ù‚ÙŠØµØ±ÙŠØ©','q1.20_8':'ØµØ­Ø© Ø§Ù„Ø·ÙÙ„','q1.20_9':'Ù„Ù‚Ø§Ø­','q1.20_10':'Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø·ÙÙ„','q1.20_11':'Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ù…Ø±Ø§Ù‡Ù‚ÙŠÙ†','q1.20_12':'Ù…Ø³Ù†ÙŠÙ†','q1.20_13':'ØµØ­Ø© Ø§Ù„ÙÙ… ÙˆØ§Ù„Ø£Ø³Ù†Ø§Ù†','q1.20_14':'Ù†ÙØ³ÙŠØ©','q1.20_15':'Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ø³Ø§Ø±ÙŠØ©','q1.20_16':'Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠ','q1.20_17':'ØµÙŠØ¯Ù„ÙŠØ©','q1.20_18':'Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©','q1.20_19':'Ø³ÙƒØ±ÙŠ','q1.20_20':'Ø¬Ø±Ø§Ø­Ø© ØµØºØ±Ù‰','q1.20_21':'Ø¬Ø±Ø§Ø­ÙŠØ©','q1.20_22':'ØªÙ†Ø¸ÙŠØ±ÙŠØ©','q1.20_23':'ØºØ³ÙŠÙ„ Ø§Ù„ÙƒÙ„Ù‰','q1.20_24':'Ù…Ø¹Ø§Ù„Ø¬Ø© ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ©','q1.20_25':'Ø§Ù„Ø£Ø´Ø¹Ø©','q1.20_26':'Ø¹ÙŠØ§Ø¯Ø© Ø¹Ø§Ù…Ø©','q1.20_27':'Ø§Ø³Ø¹Ø§Ù','q1.20_-96':'Ø®Ø¯Ù…Ø§Øª Ø£Ø®Ø±Ù‰'}
    present=[c for c in service_map if c in df.columns]
    if present:
        rows=[]
        for c in present:
            yes=df[c].apply(is_yes).sum(); tot=df[c].notna().sum()
            rows.append({'Ø§Ù„Ø®Ø¯Ù…Ø©':service_map[c],'Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙˆÙØ± %':percent(yes,tot),'Ø¹Ø¯Ø¯ Ù†Ø¹Ù…':yes,'Ø¥Ø¬Ù…Ø§Ù„ÙŠ':tot})
        svc=pd.DataFrame(rows).sort_values('Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙˆÙØ± %', ascending=False)
        bar=px.bar(svc.head(15), x='Ø§Ù„Ø®Ø¯Ù…Ø©', y='Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙˆÙØ± %', title='Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ØªÙˆÙØ±Ø§Ù‹', text='Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙˆÙØ± %', color_discrete_sequence=[PRIMARY])
        bar.update_traces(texttemplate='%{text:.1f}%', textposition='outside', cliponaxis=False)
        bar.update_layout(xaxis_tickangle=-20, margin=dict(t=60,b=110))
        st.plotly_chart(bar, use_container_width=True)
        # Heatmap clearer
        if 'governorate_entry' in df.columns:
            govs=sorted(df['governorate_entry'].dropna().unique())
            heat=[]
            for g in govs:
                dfg=df[df['governorate_entry']==g]
                row={'Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©':g}
                for c in present:
                    yes=dfg[c].apply(is_yes).sum(); tot=dfg[c].notna().sum()
                    row[service_map[c]]=round(percent(yes,tot),1)
                heat.append(row)
            hdf=pd.DataFrame(heat).set_index('Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©')
            hfig=px.imshow(hdf, aspect='auto', color_continuous_scale='Greens', origin='lower', labels=dict(color='Ù†Ø³Ø¨Ø© %'), title='Ø®Ø±ÙŠØ·Ø© Ø­Ø±Ø§Ø±ÙŠØ© â€” ØªÙˆÙØ± Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©', zmin=0, zmax=100, text_auto=True)
            hfig.update_layout(coloraxis_colorbar=dict(ticksuffix='%'))
            st.plotly_chart(hfig, use_container_width=True)
        st.dataframe(svc, use_container_width=True, hide_index=True)
    else:
        st.warning('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª q1.20_* ÙÙŠ Ø§Ù„Ù…Ù„Ù.')

with tabs[2]:
    kpis(df)
    staff_labels={'q2_1':'Ø·Ø¨ÙŠØ¨ Ø¹Ø§Ù…','q2_2':'Ø·Ø¨ÙŠØ¨ Ù…Ù‚ÙŠÙ…','q2_3':'Ø§Ø®ØªØµØ§ØµÙŠ Ø£Ø³Ø±Ø©','q2_4':'Ø§Ø®ØªØµØ§ØµÙŠ Ø£Ø·ÙØ§Ù„','q2_5':'Ø§Ø®ØªØµØ§ØµÙŠ Ù†Ø³Ø§Ø¦ÙŠØ©','q2_6':'Ø§Ø®ØªØµØ§ØµÙŠ Ø¯Ø§Ø®Ù„ÙŠØ©','q2_7':'Ø§Ø®ØªØµØ§ØµÙŠ Ù‚Ù„Ø¨ÙŠØ©','q2_8':'Ø§Ø®ØªØµØ§ØµÙŠ Ø¬Ø±Ø§Ø­Ø© Ø¹Ø§Ù…Ø©','q2_9':'Ø§Ø®ØªØµØ§ØµÙŠ Ø·ÙˆØ§Ø±Ø¦','q2_10':'Ø£Ù†Ù Ø£Ø°Ù† Ø­Ù†Ø¬Ø±Ø©','q2_11':'Ø¹ÙŠÙ†ÙŠØ©','q2_12':'Ø£Ø´Ø¹Ø©','q2_13':'Ù†ÙØ³ÙŠ','q2_14':'Ø·Ø¨ÙŠØ¨ Ø£Ø³Ù†Ø§Ù†','q2_15':'ØµÙŠØ¯Ù„Ø§Ù†ÙŠ','q2_16':'Ø¬Ù„Ø¯ÙŠØ©','q2_17':'Ø¨ÙˆÙ„ÙŠØ©','q2_18':'Ø¹Ø¸Ù…ÙŠØ©','q2_19':'Ù…Ø®Ø¨Ø±','q2_20':'Ù…Ø¹Ø§Ù„Ø¬Ø© ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ©','q2_21':'ØªÙ…Ø±ÙŠØ¶','q2_22':'Ù‚Ø§Ø¨Ù„Ø§Øª','q2_23':'ÙÙ†ÙŠ Ø£Ø´Ø¹Ø©','q2_24':'ÙÙ†ÙŠ Ù…Ø®Ø¨Ø±','q2_25':'ÙÙ†ÙŠ ØµÙŠØ¯Ù„Ø©','q2_26':'ÙÙ†ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ©','q2_27':'ÙÙ†ÙŠ Ø£Ø³Ù†Ø§Ù†','q2_28':'ÙÙ†ÙŠ ØµØ­Ø© Ø¹Ø§Ù…Ø©','q2_29':'Ù…Ø³Ø§Ø¹Ø¯/Ø© Ù…Ù…Ø±Ø¶/Ø©','q2_30':'Ù…Ø±Ø´Ø¯ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ','q2_31':'Ø¥Ø¯Ø§Ø±ÙŠ','q2_32':'Ù‡Ù†Ø¯Ø³ÙŠ','q2_33':'Ø®Ø¯Ù…ÙŠ','q2_34':'ÙÙ†ÙŠ Ø¥Ø­ØµØ§Ø¡','q2_35':'ÙÙ†ÙŠ ØªØ®Ø¯ÙŠØ±','q2_36':'ÙÙ†ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª','q2_37':'ÙÙ†ÙŠ Ø£Ø·Ø±Ø§Ù ØµÙ†Ø§Ø¹ÙŠØ©','q2_39':'Ù…Ø³Ø§Ø¹Ø¯ Ù…Ù‡Ù†Ø¯Ø³','q2__96_yn_1':'ÙƒØ§Ø¯Ø± Ø¢Ø®Ø± (1)','q2__96_yn_2':'ÙƒØ§Ø¯Ø± Ø¢Ø®Ø± (2)'}
    present=[c for c in staff_labels if c in df.columns]
    if present:
        rows=[]
        for c in present:
            yes=df[c].apply(is_yes).sum(); tot=df[c].notna().sum()
            rows.append({'Ø§Ù„ÙØ¦Ø©':staff_labels[c],'Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙˆÙØ± %':percent(yes,tot),'Ø¹Ø¯Ø¯ Ù†Ø¹Ù…':yes,'Ø¥Ø¬Ù…Ø§Ù„ÙŠ':tot})
        sdf=pd.DataFrame(rows).sort_values('Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙˆÙØ± %', ascending=False)
        fig=px.bar(sdf.head(15), x='Ø§Ù„ÙØ¦Ø©', y='Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙˆÙØ± %', title='Ø£ÙƒØ«Ø± ÙØ¦Ø§Øª Ø§Ù„ÙƒØ§Ø¯Ø± Ø§Ù„Ù…ØªÙˆÙØ±Ø©', text='Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙˆÙØ± %', color_discrete_sequence=[GOLD])
        fig.update_traces(texttemplate='%{text:.1f}%', textposition='outside', cliponaxis=False)
        fig.update_layout(xaxis_tickangle=-20, margin=dict(t=60,b=110))
        st.plotly_chart(fig, use_container_width=True)
        # staff heatmap by governorate
        if 'governorate_entry' in df.columns:
            govs=sorted(df['governorate_entry'].dropna().unique())
            heat=[]
            for g in govs:
                dfg=df[df['governorate_entry']==g]
                row={'Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©':g}
                for c in present:
                    yes=dfg[c].apply(is_yes).sum(); tot=dfg[c].notna().sum()
                    row[staff_labels[c]]=round(percent(yes,tot),1)
                heat.append(row)
            hdf=pd.DataFrame(heat).set_index('Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©')
            hfig=px.imshow(hdf, aspect='auto', color_continuous_scale='YlGnBu', origin='lower', labels=dict(color='Ù†Ø³Ø¨Ø© %'), title='Ø®Ø±ÙŠØ·Ø© Ø­Ø±Ø§Ø±ÙŠØ© â€” ØªÙˆÙØ± Ø§Ù„ÙƒØ§Ø¯Ø± Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©', zmin=0, zmax=100, text_auto=True)
            hfig.update_layout(coloraxis_colorbar=dict(ticksuffix='%'))
            st.plotly_chart(hfig, use_container_width=True)
        st.dataframe(sdf, use_container_width=True, hide_index=True)
    else:
        st.warning('ØµÙØ­Ø© Ø§Ù„ÙƒÙˆØ§Ø¯Ø± ÙØ§Ø±ØºØ© Ù„Ø£Ù† Ø£Ø¹Ù…Ø¯Ø© q2_* ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙˆØ¹. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¶Ù…ÙŠÙ† Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ÙƒØ§Ø¯Ø±.')

with tabs[3]:
    kpis(df)
    c1,c2,c3,c4=st.columns(4)
    total=df['q3.1'].sum() if 'q3.1' in df.columns else 0
    active=df['q3.1_active'].sum() if 'q3.1_active' in df.columns else 0
    inactive=df['q3.1_not_active'].sum() if 'q3.1_not_active' in df.columns else 0
    los=df['q3.1_admission_avg'].mean() if 'q3.1_admission_avg' in df.columns else 0
    c1.metric('Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£Ø³Ø±Ø©', f'{int(total):,}')
    c2.metric('Ø§Ù„Ø£Ø³Ø±Ø© Ø§Ù„ÙØ¹Ù‘Ø§Ù„Ø©', f'{int(active):,}')
    c3.metric('Ø§Ù„Ø£Ø³Ø±Ø© ØºÙŠØ± Ø§Ù„ÙØ¹Ù‘Ø§Ù„Ø©', f'{int(inactive):,}')
    c4.metric('Ù…ØªÙˆØ³Ø· Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©', f'{los:.1f}')
    for a,i,title in [('q3.3.1_active','q3.3.1_inactive','Ø£Ø³Ø±Ø© Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø§Ù„Ù…Ø´Ø¯Ø¯Ø©'),('q3.3.2_active','q3.3.2_inactive','Ø§Ù„Ù…Ù†Ø§ÙØ³'),('q3.3.3_active','q3.3.3_inactive','Ø§Ù„Ø­ÙˆØ§Ø¶Ù†')]:
        if a in df.columns and i in df.columns:
            sums=pd.DataFrame({'Ø§Ù„Ø­Ø§Ù„Ø©':['ÙØ¹Ù‘Ø§Ù„Ø©','Ù…Ø¹Ø·Ù„Ø©'],'Ø§Ù„Ø¹Ø¯Ø¯':[df[a].sum(),df[i].sum()],'Ø§Ù„ÙØ¦Ø©':[title,title]})
            bf=px.bar(sums, x='Ø§Ù„ÙØ¦Ø©', y='Ø§Ù„Ø¹Ø¯Ø¯', color='Ø§Ù„Ø­Ø§Ù„Ø©', barmode='group', title=title, color_discrete_sequence=[PRIMARY,GOLD])
            st.plotly_chart(bf, use_container_width=True)

with tabs[4]:
    kpis(df)
    cols=st.columns(4)
    if 'q4.5' in df.columns:
        yes=df['q4.5'].apply(is_yes).sum(); tot=df['q4.5'].notna().sum()
        cols[0].metric('ØªÙˆÙØ± Ø³ÙŠØ§Ø±Ø© Ø¥Ø³Ø¹Ø§Ù ðŸš‘', f'{percent(yes,tot):.1f}%')
    if 'q4.8' in df.columns:
        yes=df['q4.8'].apply(is_yes).sum(); tot=df['q4.8'].notna().sum()
        cols[1].metric('Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ù…ØªÙˆÙØ±Ø© âš¡', f'{percent(yes,tot):.1f}%')
    if 'q4.17' in df.columns:
        duty=df['q4.17'].value_counts().reset_index(); duty.columns=['ÙØªØ±Ø© Ø§Ù„Ø¯ÙˆØ§Ù…','Ø¹Ø¯Ø¯']
        ib=px.bar(duty, x='ÙØªØ±Ø© Ø§Ù„Ø¯ÙˆØ§Ù…', y='Ø¹Ø¯Ø¯', title='ÙØªØ±Ø© Ø§Ù„Ø¯ÙˆØ§Ù… ÙÙŠ Ø§Ù„Ù…Ù†Ø´Ø¢Øª', color_discrete_sequence=[PRIMARY])
        ib.update_layout(margin=dict(t=60,b=80))
        cols[2].plotly_chart(ib, use_container_width=True)
    if 'q4.18' in df.columns:
        water=df['q4.18'].value_counts().reset_index(); water.columns=['Ù…ØµØ¯Ø± Ø§Ù„Ù…ÙŠØ§Ù‡','Ø¹Ø¯Ø¯']
        ip=px.pie(water, names='Ù…ØµØ¯Ø± Ø§Ù„Ù…ÙŠØ§Ù‡', values='Ø¹Ø¯Ø¯', hole=0.45, title='Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…ÙŠØ§Ù‡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', color_discrete_sequence=SEQ)
        cols[3].plotly_chart(ip, use_container_width=True)

with tabs[5]:
    kpis(df)
    st.subheader('Ø³Ø¬Ù„ Ø§Ù„Ù…Ù†Ø´Ø¢Øª (ØªÙØµÙŠÙ„ÙŠ)')
    col_map={'facility_id':'Ø§Ù„Ø±Ù…Ø² Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ Ù„Ù„Ù…Ù†Ø´Ø£Ø©','facility_name':'Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©','DateOfVisit':'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©','enumerator_id':'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ Ù„Ù„Ø¨Ø§Ø­Ø«','enumerator_name':'Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø­Ø«','governorate_entry':'Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©','area_entry':'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©/Ø§Ù„Ù„ÙˆØ§Ø¡','facility_state':'Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø´Ø£Ø©','q1.7':'ÙØ¦Ø© Ø§Ù„Ù…Ù†Ø´Ø£Ø©','q1.8':'ØªØ¨Ø¹ÙŠØ© Ø§Ù„Ù…Ù†Ø´Ø£Ø©','q1.10':'ØªØ±Ø®ÙŠØµ','q1.9.6':'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ÙŠÙ† (Ø¢Ø®Ø± Ø´Ù‡Ø±)','q1.9.7':'Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù† Ø§Ù„Ù…Ø®Ø¯Ù‘Ù…ÙŠÙ† ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹'}
    show_cols=[c for c in col_map if c in df.columns]
    df_show=df[show_cols].rename(columns=col_map) if show_cols else pd.DataFrame()
    sort_col='ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©' if 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©' in df_show.columns else (df_show.columns[0] if len(df_show.columns) else None)
    if sort_col: df_show=df_show.sort_values(by=sort_col, ascending=False)
    st.dataframe(df_show, use_container_width=True, hide_index=True)
    csv=df.to_csv(index=False).encode('utf-8-sig')
    st.download_button('ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„ØªØµÙÙŠØ© (CSV)', data=csv, file_name='filtered_moh_dataset.csv', mime='text/csv')
streamlit==1.37.1
pandas>=2.0.0
numpy>=1.23.0
plotly>=5.22.0

